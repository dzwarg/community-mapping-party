<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Display a map on a webpage</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
<style>
body { margin: 0; padding: 0; }
#map { position: absolute; top: 0; bottom: 0; width: 100%; }
</style>
</head>
<body>
<div id="map"></div>
<script>
	mapboxgl.accessToken = 'pk.eyJ1IjoiZHp3YXJnMiIsImEiOiJja2VidXkweWwwY2hqMnFvYXZwOG51MDBoIn0.5tG41YFoo3NHZsHYR-12LA';
	const map = new mapboxgl.Map({
		container: 'map', // container ID
        // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
        style: 'mapbox://styles/dzwarg2/clekuzenb000v01ps32sectby', // style URL
        center: [-70.187361, 43.802546], // starting position [lng, lat]
        zoom: 16 // starting zoom
    });
	// Add geolocate control to the map.
	const geolocate = new mapboxgl.GeolocateControl({
		positionOptions: {
			enableHighAccuracy: true
		},
		// When active the map will receive updates to the device's location as it changes.
		trackUserLocation: true,
		// Draw an arrow next to the location dot to indicate which direction the device is heading.
		showUserHeading: true
	});
	map.addControl(geolocate);
	const buffer = []
	geolocate.on('geolocate', function (evt) {
	  console.log(evt);
	  evt.time = (new Date()).toUTCString()
	  buffer.push(evt);
	});

	function download(filename, track) {
	  var element = document.createElement('a');
	  element.setAttribute('href', 'data:application/gpx+xml;charset=utf-8,' + encodeURIComponent(track));
	  element.setAttribute('download', filename);

	  element.style.display = 'none';
	  document.body.appendChild(element);

	  element.click();

	  document.body.removeChild(element);
	}

	const track = `<?xml version="1.0" encoding="UTF-8" standalone="no" ?>

<gpx xmlns="http://www.topografix.com/GPX/1/1" xmlns:gpxx="http://www.garmin.com/xmlschemas/GpxExtensions/v3" xmlns:gpxtpx="http://www.garmin.com/xmlschemas/TrackPointExtension/v1" creator="dzwarg/community-mapping-party" version="1.1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd http://www.garmin.com/xmlschemas/GpxExtensions/v3 http://www.garmin.com/xmlschemas/GpxExtensionsv3.xsd http://www.garmin.com/xmlschemas/TrackPointExtension/v1 http://www.garmin.com/xmlschemas/TrackPointExtensionv1.xsd">
  <metadata>
    <link href="http://dzwarg.github.io/community-mapping-party">
      <text>Community Mapping Party</text>
    </link>
    <time>${(new Date()).toUTCString()}</time>
  </metadata>
  <trk>
    <name>Simple GPX Document</name>
    <trkseg>
	  ${buffer.map(function (item) {
	    return `<trkpt lat="${item.lat}" lon="${item.lon}">
        <ele>0</ele>
		<time>${item.time}</time>
	  </trkpt>`;
	  }).join('')}
    </trkseg>
  </trk>
</gpx>`

	// Control implemented as ES5 prototypical class
	function HelloWorldControl() { }

	HelloWorldControl.prototype.onAdd = function(map) {
		this._map = map;
		this._container = document.createElement('div');
		this._container.className = 'mapboxgl-ctrl';

		const link = document.createElement('a');
		link.setAttribute('href', '#');
		link.addEventListener('click', function() { download("hello.gpx", track); });
		link.innerHTML = "Download<br/>Track";
		this._container.appendChild(link);
		return this._container;
	};

	HelloWorldControl.prototype.onRemove = function () {
		this._container.parentNode.removeChild(this._container);
		this._map = undefined;
	};

	map.addControl(new HelloWorldControl());

</script>

</body>
</html>
